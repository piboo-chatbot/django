{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Piboo-chat</title>
    <link rel="stylesheet" href="{% static 'style/chatbot.css' %}">
</head>
<body>
    <div class="logo-area">
        <img src="{% static 'images/intro.png' %}" class="logo-img" alt="Piboo Logo">
        <span class="logo-text">Piboo</span>
    </div>
    <div class="chat-area" id="chat-area"></div>
    <div class="input-area">
        <div class="input-container">
            <input type="text" class="input-box" id="user-input" placeholder="" autocomplete="off"/>
            <button class="send-btn" id="send-btn">Send</button>
        </div>
    </div>
    <script>
        const chatArea = document.getElementById("chat-area");
        const inputBox = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-btn");

        let messages = [];
        
         // CSRF 토큰 가져오기 함수
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function renderMessages() {
            function formatContent(str) {
                const escaped = str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                return escaped
                    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                    .replace(/\n/g, "<br>");
            }
            chatArea.innerHTML = "";
            for (const msg of messages) {
                const div = document.createElement("div");
                div.className = "message-bubble " + (msg.role === "user" ? "user-message" : "bot-message");
                div.innerHTML = formatContent(msg.content);
                chatArea.appendChild(div);
            }
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendMessage() {
            const val = inputBox.value.trim();
            if (!val) return;
            messages.push({role: "user", content: val});
            renderMessages();
            inputBox.value = "";

            try {
                const response = await fetch("{% url 'ask' %}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json",
                                "X-CSRFToken": csrftoken
                     },
                    body: JSON.stringify({ query: val })
                });
                if (response.ok) {
                    const data = await response.json();
                    messages.push({role: "bot", content: data.answer || "답변이 없습니다."});
                } else {
                    messages.push({role: "bot", content: "❌ 오류가 발생했습니다. 다시 시도해주세요."});
                }
            } catch (e) {
                messages.push({role: "bot", content: "❌ 서버 연결 오류: " + e});
            }
            renderMessages();
        }

        sendBtn.onclick = sendMessage;
        let isComposing = false;
        inputBox.addEventListener("compositionstart", () => { isComposing = true; });
        inputBox.addEventListener("compositionend", () => { isComposing = false; });

        inputBox.addEventListener("keydown", function(e) {
            if (e.key === "Enter" && !isComposing) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>
</html>