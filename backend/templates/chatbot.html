{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Piboo-chat</title>
  <link rel="stylesheet" href="{% static 'style/chatbot.css' %}">
  <style>
    /* 간단한 메뉴바 스타일 (필요시 style/chatbot.css에 통합하세요) */
    .sidebar {
      position: fixed;
      right: -200px; /* 시작은 숨김 */
      top: 0;
      width: 200px;
      height: 100%;
      background: #ff3b5c;
      color: #fff;
      transition: right 0.3s;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1000;
    }
    .sidebar.show {
      right: 0;
    }
    .menu-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff3b5c;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 10px 15px;
      cursor: pointer;
      z-index: 1001;
    }
    .sidebar a {
      display: block;
      margin-bottom: 15px;
      color: #fff;
      text-decoration: none;
    }
    .sidebar a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <button class="menu-toggle">≡</button>
  <div class="sidebar" id="sidebar">
    <h2>메뉴</h2>
    <a href="{% url 'mypage' %}">마이페이지</a>
    <a href="#">설정</a>
    {% if user.is_authenticated %}
    <a href="{% url 'logout' %}">로그아웃</a>
    {% endif %}
  </div>

  <div class="logo-area">
    <img src="{% static 'images/intro.png' %}" class="logo-img" alt="Piboo Logo">
    <span class="logo-text">Piboo</span>
  </div>
  <div class="welcome-message" style="text-align:center; font-size:16px; margin: 20px 0; color:#ff3b5c;">
    {{ user.nickname }}님 환영합니다! 무엇을 도와드릴까요?
  </div>
  <div class="chat-area" id="chat-area"></div>

  <div class="input-area">
    <div class="input-container">
      <input type="text" class="input-box" id="user-input" placeholder="질문을 입력하세요..." autocomplete="off" />
      <button class="send-btn" id="send-btn">Send</button>
    </div>
  </div>

  <script>
    const chatArea = document.getElementById("chat-area");
    const inputBox = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.querySelector(".menu-toggle");

    let messages = [];

    // 메뉴 토글
    menuToggle.onclick = () => {
      sidebar.classList.toggle("show");
    };

    // CSRF 토큰 가져오기
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

function renderMessages() {
            function formatContent(str) {
                const escaped = str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
                return escaped
                    .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
                    .replace(/\n/g, "<br>");
            }

            chatArea.innerHTML = "";

            for (const msg of messages) {
                const div = document.createElement("div");
                div.className = "message-bubble " + (msg.role === "user" ? "user-message" : "bot-message");
                div.innerHTML = formatContent(msg.content);
                chatArea.appendChild(div);
            }

            // 스크롤 하단 고정
            setTimeout(() => {
                const lastMsg = chatArea.lastElementChild;
                if (lastMsg) {
                    lastMsg.scrollIntoView({ behavior: "smooth", block: "end" });
                }

                window.scrollTo({
                    top: document.documentElement.scrollHeight,
                    behavior: 'smooth'
                });

            }, 0);
            
        }
      chatArea.innerHTML = "";
      for (const msg of messages) {
        const div = document.createElement("div");
        div.className = "message-bubble " + (msg.role === "user" ? "user-message" : "bot-message");
        div.innerHTML = formatContent(msg.content);
        chatArea.appendChild(div);
      }
      chatArea.scrollTop = chatArea.scrollHeight;
    

    async function sendMessage() {
      const val = inputBox.value.trim();
      if (!val) return;
      messages.push({ role: "user", content: val });
      renderMessages();
      inputBox.value = "";

      try {
        const response = await fetch("{% url 'ask' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ query: val })
        });
        if (response.ok) {
          const data = await response.json();
          messages.push({ role: "bot", content: data.answer || "답변이 없습니다." });
        } else {
          messages.push({ role: "bot", content: "❌ 오류가 발생했습니다. 다시 시도해주세요." });
        }
      } catch (e) {
        messages.push({ role: "bot", content: "❌ 서버 연결 오류: " + e });
      }
      renderMessages();
    }

    sendBtn.onclick = sendMessage;
    let isComposing = false;
    inputBox.addEventListener("compositionstart", () => { isComposing = true; });
    inputBox.addEventListener("compositionend", () => { isComposing = false; });
    inputBox.addEventListener("keydown", function(e) {
      if (e.key === "Enter" && !isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
